# 网络层概述

网络层实现数据包的选择和转发。广域网或者说互联网通常使用众多分级的路由器来连接分散的主机或者局域网，因此，通信的两台主机一般不是直接相连的，而是通过多个中间结点（路由器）连接的。同时，网络层对上层协议隐藏了网络拓扑连接的细节，使得在传输层和网络应用程序看来，通信的双方是直接相连的

 <img src="img/%E7%BD%91%E7%BB%9C%EF%BC%9A3%E7%BD%91%E7%BB%9C%E5%B1%82%E3%80%81IP.img/image-20210105100853671.png" alt="image-20210105100853671" style="zoom:60%;" />

==IP协议==：Internet Protocol，网际互联协议，是网络层最核心的协议。IP协议根据数据包的目的IP地址来决定如何投递它。如果数据包不能直接发送给目标主机，那么IP协议就为它寻找一个合适的下一跳路由器，并将数据包交付给该路由器来转发。多次重复这一过程，数据包最终到达目标主机，或者由于发送失败而丢弃。可见，IP协议使用逐跳的方式确定通信路径

==ICMP协议==：Internet Control Message Protocol，因特网控制报文协议，是网络层另外一个重要的协议，它是IP协议的重要补充，主要用于检测网络连接

# IP协议

IP协议是网络层一个协议，特点是：==无连接，不可靠，无状态==，IP协议主要来实现报文段在网络环境中的转发

每台路由器在转发报文段时，根据IP协议进行转发，而且它只是尽最大能力去转发，并不会保证将报文段发送到目的主机

- 无连接：是指IP通信双方都不长久地维持对方的任何信息。这样，上层协议每次发送数据的时候，都必须明确指定对方的IP地址
- 不可靠：是指IP协议不能保证IP数据报准确地到达接收端，它只是承诺尽最大努力
- 无状态：是指通信双方不同步传输数据的状态信息，因此所有IP数据报的发送、传输和接收都是相互独立、没有上下文关系的。这种服务的最大缺点是无法处理乱序和重复的IP数据报。虽然IP数据报头部提供了一个标识字段用以唯一标识一个IP数据报，但它是被用来处理IP分片和重组的，而不是用来指示接收顺序的。无状态的优点是简单、高效，无须为保持通信状态而分配一些内核资源，也无须再每次通信时携带状态信息

# IPv4协议的报头结构

 <img src="img/%E7%BD%91%E7%BB%9C%EF%BC%9A3%E7%BD%91%E7%BB%9C%E5%B1%82%E3%80%81IP.img/image-20210105102742015.png" alt="image-20210105102742015" style="zoom:50%;" />

- 4位版本号（version）：指定IP协议的版本。IPv4的值是4
- 4位头部长度（header length）：标识该IP头部有多少个32bit（4字节）。因为4位最大能表示15，所以IP头部最长是60字节
- 8位服务类型（Type Of Service，TOS）：包括一个3位的优先权字段（现已被忽略），4位的TOS字段和1位保留字段（必须置零）。4位的TOS字段分别表示：最小延时，最大吞吐量，最高可靠性和最小费用。其中最多有一个能置为1，应用程序应该根据实际需要来设置它。比如像ssh和telnet这样的登录程序需要的是最小延时的服务，而文件传输程序ftp则需要最大吞吐量的服务
- 16位总长度（total length）：是指整个IP数据报的长度，以字节为单位，因此IP数据报的最大长度为65535（2^16 - 1）字节。但是由于MTU的限制，长度超过MTU的数据报都将被分片传输，所以实际传输的IP数据报（或分片）的长度都远远没有达到最大值。以下三个字段描述了如何实现分片
- 16位标识（identification）：唯一地标识主机发送的每一个数据报。其初始值由系统随机生成；每发送一个数据报，其值就加1。该值在数据报分片时被复制到每个分片中，因此同一个数据报的所有分片都具有相同的标识值
- 3位标志字段的第一位保留。第二位（Don't Fragment, DF）表示“禁止分片”。如果设置了这个位，IP模块将不对数据报进行分片。在这种情况下，如果IP数据报长度超过MTU的话，IP模块将丢弃该数据报并返回一个ICMP差错报文。第三位（More Fragment，MF）表示更多分片。除了数据报的最后一个分片外，其它分片都要把它置为1
- 13位分片偏移（fragmentation offset）：是分片相对原始IP数据报开始处（仅指数据部分）的偏移。实际的偏移值是该值左移3位（乘8）后得到的。由于这个原因，除了最后一个IP分片外，每个IP的数据部分的长度必须是8的整数倍（这样才能保证后面的IP分片拥有一个合适的偏移值）
	> IP分片
	>
	> 当IP数据报的长度超过帧的MTU时，它将被分片传输
	>
	> IP分片既会在发送端发生，也可能在中间的路由器上发生
	>
	> <img src="img/%E7%BD%91%E7%BB%9C%EF%BC%9A3%E7%BD%91%E7%BB%9C%E5%B1%82%E3%80%81IP.img/image-20210105104612420.png" alt="image-20210105104612420" style="zoom:50%;" />

- 8位的TTL：time to live，IP报文段在网络转发过程中的生存时间，最多经过的路由器个数。将其称之为跳数。每经过一个路由器，则对TTL减一。当其减到为0时，就将这个报文段直接丢弃——用来防止在网络环境数据报的转发形成环
- 8位协议：表示上层协议，ICMP—1，TCP—6，UDP—17
- 16位头部检验和：只会对IP数据报的头部进行校验，提高转发的效率
- 32位源端IP地址和32位目的端IP地址

IPv6的头部结构和IPv4是不一样的，下图是IPv6的头部结构

 <img src="img/%E7%BD%91%E7%BB%9C%EF%BC%9A3%E7%BD%91%E7%BB%9C%E5%B1%82%E3%80%81IP.img/image-20210105105324015.png" alt="image-20210105105324015" style="zoom:50%;" />

**查看本地IP地址**

windows环境：

win+r — cmd — ipconfig

![image-20210105110136461](img/%E7%BD%91%E7%BB%9C%EF%BC%9A3%E7%BD%91%E7%BB%9C%E5%B1%82%E3%80%81IP.img/image-20210105110136461.png)

Linux环境：

ifconfig

![image-20210105115756462](img/%E7%BD%91%E7%BB%9C%EF%BC%9A3%E7%BD%91%E7%BB%9C%E5%B1%82%E3%80%81IP.img/image-20210105115756462.png)